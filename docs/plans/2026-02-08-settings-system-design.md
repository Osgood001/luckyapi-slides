# Design: Settings-Based Visual Consistency System (设定集)

**Date**: 2026-02-08
**Status**: Approved

## Problem

Each slide/page is generated by an independent API call with no shared visual context. This causes visual inconsistency across pages — characters look different, styles drift, props change appearance.

## Solution

A two-phase pipeline with a **设定集 (setting bible)** that anchors visual identity:

1. **Phase 1 — Guided Setting Creation**: Walk user through defining settings (art style, characters, world, props). Generate reference images for each. User confirms before proceeding.
2. **Phase 2 — Content Generation**: Feed confirmed settings (text descriptions + base64-encoded reference images) into each generation call.

## Technical Findings

- LuckyAPI with `(按次)gemini-3-pro-image-preview` supports multi-modal input
- **Base64 image input works** — images encoded as `data:image/png;base64,...`
- **URL-based image input fails** (500 error, no available channel)
- Reference images must be resized before encoding to keep payload reasonable

## Folder Structure

```
project/
├── settings/
│   ├── settings.json              # Master index: text + image paths
│   ├── art_style/
│   │   └── *.png
│   ├── characters/
│   │   └── <name>/
│   │       └── *.png
│   ├── world/
│   │   └── *.png
│   └── props/
│       └── *.png
├── slides/
│   └── NN_name.png
├── slide_plan.json
└── output/
    └── presentation.pdf
```

## settings.json Format

```json
{
  "art_style": {
    "description": "Dark navy background, cyan accents, clean minimal layout, 16:9",
    "images": ["settings/art_style/palette_ref.png"]
  },
  "characters": {
    "hero": {
      "description": "Young woman, short black hair, lab coat, confident expression",
      "images": ["settings/characters/hero/front.png"]
    }
  },
  "world": {},
  "props": {}
}
```

## slide_plan.json Format

```json
{
  "style_prefix": "16:9 presentation slide, dark navy background, cyan accents",
  "slides": [
    {
      "filename": "01_title.png",
      "prompt": "Title slide: 'Machine Learning 101'. Subtitle: 'A Practical Guide'.",
      "settings": ["art_style", "characters.hero"]
    }
  ]
}
```

## Scripts

| Script | Purpose |
|--------|---------|
| `settings_init.py` | Create folder structure + empty `settings.json` |
| `settings_scan.py` | Scan folders, detect unindexed files, print dashboard JSON |
| `settings_add.py` | Add entry to `settings.json` |
| `generate_reference.py` | Generate a reference image, auto-resize, save to subfolder |
| `generate_slide.py` | (Updated) `--reference-images` flag, base64 encode, multi-modal |
| `generate_deck.py` | Orchestrate: read plan, generate all slides (parallel), combine PDF |
| `slides_to_pdf.py` | (Existing) Combine images into PDF |

## Automation Split

**Model does** (intelligence):
- Guide user through settings brainstorming
- Decide which settings are relevant per slide
- Write text prompts for each slide
- Write `slide_plan.json`

**Scripts do** (mechanical):
- Folder creation and scanning
- Image resize + base64 encoding
- API calls for reference and slide generation
- Parallel orchestration
- PDF assembly

## Workflow

### Phase 1: Settings Creation

1. Run `settings_scan.py` → get dashboard → present to user
2. User picks a category to define (any order, can skip/revisit)
3. For each setting element:
   - User describes what they want
   - Source: AI-generated / web search / user-provided file
   - System generates or accepts reference image
   - User confirms or iterates
   - Save to subfolder, update `settings.json`
4. Support manual file placement — detect unindexed files on dashboard refresh
5. User confirms all settings → proceed to Phase 2

### Phase 2: Content Generation

1. User defines content sequence
2. Model writes `slide_plan.json`
3. Run `generate_deck.py slide_plan.json` → parallel generation → PDF
4. User reviews PDF
5. Can regenerate individual pages (settings remain available)

## Setting Categories

- **Art style / visual theme**: Color palette, typography, layout, background
- **Characters**: People, mascots — consistent appearance across pages
- **World / setting**: Environments, locations, atmosphere
- **Props / items**: Objects, logos, icons, recurring elements

## Content Types Supported

Slides, comics, manga, cartoons — all use the same pipeline. The difference is in prompt content and settings complexity, not architecture.
